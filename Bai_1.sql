CREATE DATABASE BAI_1
USE BAI_1
CREATE TABLE KHACHHANG
(
	MaKH CHAR(4) NOT NULL PRIMARY KEY,
	HoTen VARCHAR(40),
	DChi VARCHAR(50),
	SoDT VARCHAR(20),
	NgSinh SMALLDATETIME,
	NgDK SMALLDATETIME,
	DoanhSo MONEY
)
CREATE TABLE NHANVIEN
(
	MaNV CHAR(4) NOT NULL PRIMARY KEY,
	HoTen VARCHAR(40),
	SoDT VARCHAR(20),
	NgVL SMALLDATETIME
)

CREATE TABLE SANPHAM
(
	MaSP CHAR(4) NOT NULL PRIMARY KEY,
	TenSP VARCHAR(40),
	DVT VARCHAR(20),
	NuocSX VARCHAR(40),
	Gia MONEY
)

CREATE TABLE HOADON
(
	SoHD INT NOT NULL PRIMARY KEY,
	NgHD SMALLDATETIME,
	MaKH CHAR(4),
	MaNV CHAR(4),
	TriGia MONEY,
	CONSTRAINT FK_MANV_HD FOREIGN KEY (MaNV) REFERENCES NHANVIEN(MaNV),
	CONSTRAINT FK_MAKH_HD FOREIGN KEY(MaKH) REFERENCES KHACHHANG(MaKH)
)

CREATE TABLE CTHD
(
	SoHD INT NOT NULL,
	MaSP CHAR(4) NOT NULL,
	SL INT,
	CONSTRAINT PK_SOHD_MASP PRIMARY KEY (SoHD, MaSP),
	CONSTRAINT FK_SOHD_CTHD FOREIGN KEY(SoHD) REFERENCES HOADON(SoHD),
	CONSTRAINT FK_MASP_CTHD FOREIGN KEY(MaSP) REFERENCES SANPHAM(MaSP)
)

INSERT INTO NHANVIEN VALUES
('NV01','Nguyen Nhu Nhut','0927345678','4/13/2006'),
('NV02', 'Le Thi Phi Yen', '0987567390','4/21/2006'),
('NV03', 'Nguyen Van B', '0997047382', '4/27/2006'),
('NV04', 'Ngo Thanh Tuan', '0913758498', '6/24/2006'),
('NV05', 'Nguyen Thi Truc Thanh', '0918590387', '7/20/2006')

INSERT INTO KHACHHANG VALUES
('KH01','Nguyen Van A', '731 Tran Hung Dao, Q5, Tp HCM','08823451','10/22/1960','7/22/2006',13060000),
('KH02','Tran Ngoc Han', '23/5 Nguyen Trai, Q5, Tp HCM','0908256478','4/3/1974','7/30/2006',280000),
('KH03','Tran Ngoc Linh', '45 Nguyen Canh Chan, Q1, Tp HCM','0938776266','6/12/1980','8/5/2006',3860000),
('KH04','Tran Minh Long', '50/34 Le Dai Hanh, Q10, Tp HCM','0917325476','3/9/1965','10/2/2006',250000),
('KH05','Le Nhat Minh', '34 Truong Dinh, Q3, TpHCM','08246108','10/3/1950','10/28/2006',21000),
('KH06','Le Hoai Thuong', '227 Nguyen Van Cu, Q5, Tp HCM','08631738','12/31/1981','11/24/2006',915000),
('KH07','Nguyen Van Tam', '32/3 Tran Binh Trong, Q5, Tp HCM','0916783565','4/6/1971','12/1/2006',12500),
('KH08','Phan Thi Thanh', '45/2 An Duong Vuong, Q5, Tp HCM','0938435756','10/1/1971','12/13/2006',365000),
('KH09','Le Ha Vinh', '873 Le Hong Phong, Q5, Tp HCM','08654763','9/3/1979','1/14/2007',70000),
('KH10','Ha Duy Lap', '34/34B Nguyen Trai, Q1, Tp HCM','08768904','5/2/1983','1/16/2007',67500)

INSERT INTO SANPHAM VALUES
('BC01','But chi', 'cay', 'Singapore', 3000),
('BC02','But chi', 'cay', 'Singapore', 5000),
('BC03','But chi', 'cay', 'Viet Nam', 3500),
('BC04','But chi', 'hop', 'Viet Nam', 30000),
('BB01','But bi', 'cay', 'Viet Nam', 5000),
('BB02','But bi', 'cay', 'Trung Quoc', 7000),
('BB03','But bi', 'hop', 'Thai Lan', 100000),
('TV01','Tap 100 giay mong', 'cay', 'Trung Quoc', 2500),
('TV02','Tap 200 giay mong', 'cay', 'Trung Quoc', 4500),
('TV03','Tap 100 giay tot', 'quyen', 'Viet Nam', 3000),
('TV04','Tap 200 giay tot', 'quyen', 'Viet Nam', 5500),
('TV05','Tap 200 trang', 'chuc', 'Viet Nam', 23000),
('TV06','Tap 100 trang', 'chuc', 'Viet Nam', 53000),
('TV07','Tap 200 trang', 'chuc', 'Viet Nam', 34000),
('ST01','So tay 500 trang', 'quyen', 'Trung Quoc', 40000),
('ST02','So tay loai 1', 'quyen', 'Viet Nam', 55000),
('ST03','So tay loai 2', 'quyen', 'Viet Nam', 51000),
('ST04','So tay', 'quyen', 'Thai Lan', 55000),
('ST05','So tay mong', 'quyen', 'Thai Lan', 20000),
('ST06','Phan viet bang', 'hop', 'Viet Nam', 5000),
('ST07','Phan khong bui', 'hop', 'Viet Nam', 7000),
('ST08','Phan viet bang', 'hop', 'Viet Nam', 1000),
('ST09','Phan khong bui', 'hop', 'Viet Nam', 5000),
('ST10','So tay 500 trang', 'quyen', 'Trung Quoc',7000)

INSERT INTO HOADON VALUES
('1001', '7/23/2006','KH01', 'NV01', 320000),
('1002', '8/12/2006','KH01', 'NV02', 840000),
('1003', '8/23/2006','KH02', 'NV01', 100000),
('1004', '9/1/2006','KH02', 'NV01', 180000),
('1005', '10/20/2006','KH01', 'NV02', 3800000),
('1006', '10/16/2006','KH01', 'NV03', 2430000),
('1007', '10/28/2006','KH03', 'NV03', 510000),
('1008', '10/28/2006','KH01', 'NV03', 440000),
('1009', '10/28/2006','KH03', 'NV04', 200000),
('1010', '11/1/2006','KH01', 'NV01', 5200000),
('1011', '11/4/2006','KH04', 'NV03', 250000),
('1012', '11/30/2006','KH05', 'NV03', 21000),
('1013', '12/12/2006','KH06', 'NV01', 500000),
('1014', '12/31/2006','KH03', 'NV02', 3150000),
('1015', '1/1/2007','KH06', 'NV01', 910000),
('1016', '1/1/2007','KH07', 'NV02', 12500),
('1017', '1/2/2007','KH08', 'NV03', 35000),
('1018', '1/13/2007','KH08', 'NV03', 330000),
('1019', '1/13/2007','KH01', 'NV03', 30000),
('1020', '1/14/2007','KH09', 'NV04', 70000),
('1021', '1/16/2007','KH09', 'NV03', 67500),
('1022', '1/16/2007',NULL, 'NV03', 27000),
('1023', '1/17/2007',NULL, 'NV01', 330000)

INSERT INTO CTHD VALUES
(1001, 'TV02', 10),
('1001', 'ST01', 5),
('1001', 'BC01', 5),
('1001', 'BC02', 10),
('1001', 'ST08', 10),
('1002', 'BC04', 20),
('1002', 'BB01', 20),
('1002', 'BB02', 20),
('1003', 'BB03', 10),
('1004', 'TV01', 20),
('1004', 'TV02', 10),
('1004', 'TV03', 10),
('1004', 'TV04', 10),
('1005', 'TV05', 50),
('1005', 'TV06', 50),
('1006', 'TV07', 20),
('1006', 'ST01', 30),
('1006', 'ST02', 10),
('1007', 'ST03', 10),
('1008', 'ST04', 8),
('1009', 'ST05', 10),
('1010', 'TV06', 50),
('1010', 'ST07', 50),
('1010', 'ST08', 100),
('1010', 'ST04', 50),
('1010', 'TV03', 100),
('1011', 'ST06', 50),
('1012', 'ST07', 3),
('1013', 'ST08', 5),
('1014', 'BC02', 80),
('1014', 'BB02', 100),
('1014', 'BC04', 60),
('1014', 'BB01', 50),
('1015', 'BB02', 30),
('1015', 'BB03', 7),
('1016', 'TV01', 5),
('1017', 'TV02', 1),
('1017', 'TV03', 1),
('1017', 'TV04', 5),
('1018', 'ST04', 6),
('1019', 'ST05', 1),
('1019', 'ST06', 2),
('1020', 'ST07', 10),
('1021', 'ST08', 5),
('1021', 'TV01', 7),
('1021', 'TV02', 10),
('1022', 'ST07', 1),
('1023', 'ST04', 6)


select top 1 with ties  a.masp, tensp, count(a.masp)
from cthd a, SANPHAM b
where a.masp = b.masp
group by a.masp, tensp
order by count(a.masp) desc;





select b.MaKH, Hoten, count(b.makh)
from KHACHHANG a, HOADON b, CTHD c, SANPHAM d
where a.MaKH = b.MaKH and b.SoHD = c.SoHD and c.MaSP = d.MaSP and d.masp in (select aa.masp from SANPHAM  aa where aa.NuocSX = 'Viet Nam')
group by b.MaKH, HoTen
having count(b.MaKH) = 3



select * from HOADON
select * from SANPHAM;
select  * from CTHD;






--On_thi
--BAI 1
SELECT MASP, TENSP
FROM SANPHAM
WHERE NuocSX LIKE 'TRUNG QUOC';
--BAI 2
SELECT MASP, TENSP
FROM SANPHAM
WHERE DVT IN ('CAY', 'QUYEN');
--BAI 3
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP LIKE 'B%01';
--BAI 4
SELECT MASP, TENSP
FROM SANPHAM
WHERE NuocSX LIKE 'TRUNG QUOC' AND Gia >= 30000 AND GIA <= 40000;
--BAI 5
SELECT MASP, TENSP
FROM SANPHAM
WHERE NuocSX IN ('TRUNG QUOC', 'THAI LAN') AND GIA IN (30000, 40000);
--BAI 6
SELECT SOHD, TriGia, NgHD
FROM HOADON
WHERE NGHD IN ('1/1/2007', '1/2/2007');
--BAI 7
SELECT SOHD, TRIGIA
FROM HOADON
WHERE MONTH(NGHD) = 1 AND YEAR(NGHD) = 2007
ORDER BY DAY(NGHD) ASC, TriGia DESC;
--BAI 8
SELECT B.MAKH, HOTEN
FROM KHACHHANG A, HOADON B
WHERE A.MaKH = B.MAKH AND NGHD = '1/1/2007';
--BAI 9
SELECT SOHD, TRIGIA
FROM HOADON A, NHANVIEN B
WHERE A.MANV = B.MaNV AND HoTen = 'NGUYEN VAN B' AND NGHD = '10/28/2006';
--BAI 10
SELECT A.MASP, TENSP
FROM SANPHAM A, KHACHHANG B, HOADON C, CTHD D
WHERE A.MASP = D.MaSP AND D.SoHD = C.SoHD AND C.MaKH = B.MaKH AND HOTEN LIKE 'NGUYEN VAN A' AND MONTH(NGHD) = 10 AND YEAR(NGHD) = 2006;
--BAI 11
SELECT B.SOHD
FROM HOADON B, SANPHAM A, CTHD C
WHERE B.SoHD = C.SoHD AND A.MaSP = C.MaSP AND A.MASP IN ('BB01', 'BB02');
--BAI 12
SELECT SoHD
FROM CTHD
WHERE MASP IN ('BB01', 'BB02') AND SL IN (10, 20);
--BAI 13
SELECT SOHD
FROM CTHD
WHERE MaSP LIKE 'BB01' AND SL IN (10, 20) AND SOHD IN ( SELECT SOHD FROM CTHD WHERE MASP LIKE 'BB02')
--BAI 14
SELECT A.MASP, TENSP, NGHD, NuocSX
FROM SANPHAM A, CTHD B, HOADON C
WHERE A.MaSP = B.MaSP AND B.SOHD = C.SOHD AND ( NGHD = '1/1/2007' OR NuocSX LIKE 'TRUNG QUOC' );
--BAI 15
SELECT MASP, TENSP
FROM SANPHAM 
WHERE MASP NOT IN (SELECT A.MASP FROM SANPHAM A, CTHD B WHERE A.MASP = B.MASP);
--BAI 16
SELECT MASP, TENSP
FROM SANPHAM
WHERE MASP NOT IN ( SELECT A.MASP FROM SANPHAM A, CTHD B, HOADON C WHERE A.MaSP = B.MaSP AND B.SoHD = C.SoHD AND YEAR(NGHD) = 2006)
--BAI 17
SELECT MASP, TENSP
FROM SANPHAM
WHERE NuocSX LIKE 'TRUNG QUOC' AND MASP NOT IN ( SELECT A.MASP FROM CTHD A, HOADON B WHERE A.SoHD = B.SoHD AND YEAR(NGHD) = 2006 AND NuocSX LIKE 'TRUNG QUOC');
--BAI 18
SELECT S.SOHD
FROM HOADON S
WHERE S.SOHD  IN (SELECT A.SOHD FROM HOADON A, CTHD B, SANPHAM C WHERE A.SOHD = S.SOHD  AND A.SoHD = B.SoHD AND B.MaSP = C.MaSP AND NuocSX LIKE 'SINGAPORE')

SELECT S.MASP, TENSP, NuocSX
FROM SANPHAM S
WHERE EXISTS ( SELECT * FROM SANPHAM G WHERE NuocSX LIKE 'VIET NAM' AND S.MaSP = G.MaSP)

SELECT * FROM SANPHAM
SELECT H.SOHD, h.MaKH
FROM HOADON H
WHERE EXISTS(SELECT *
FROM SANPHAM S
WHERE NUOCSX = 'SINGAPORE'
AND NOT EXISTS(SELECT * 
FROM CTHD C
WHERE C.SOHD = H.SOHD
AND C.MASP = S.MASP))

--BAI 19
SELECT SOHD
FROM HOADON H
WHERE YEAR(NGHD) = 2006 AND NOT EXISTS 
(SELECT * FROM SANPHAM S WHERE NuocSX LIKE 'SINGAPORE' AND NOT EXISTS 
(SELECT * FROM CTHD C WHERE C.MaSP = S.MaSP AND C.SoHD = H.SoHD))

SELECT H.SOHD 
FROM HOADON H
WHERE YEAR(NGHD) = 2006 AND NOT EXISTS(SELECT *
FROM SANPHAM S
WHERE NUOCSX = 'SINGAPORE'
AND NOT EXISTS(SELECT * 
FROM CTHD C
WHERE C.SOHD = H.SOHD
AND C.MASP = S.MASP))

select * from hoadon
select * from sanpham
select * from cthd
--section <I>
--1)
--2)
ALTER TABLE SANPHAM ADD GHICHU VARCHAR(20);

--3)
ALTER TABLE KHACHHANG ADD LOAIKH TINYINT;

--4)
ALTER TABLE SANPHAM ALTER COLUMN GHICHU VARCHAR(100);

--5)
ALTER TABLE SANPHAM DROP COLUMN GHICHU;

--8)
SELECT * FROM SANPHAM WHERE GIA >= 500;

--9)

SELECT * FROM SANPHAM
SELECT * FROM KHACHHANG

--SECTION <III>
--1)
SELECT MaSP, TenSP, NuocSX 
FROM SANPHAM 
WHERE NuocSX = 'Trung Quoc';

--2)
SELECT MaSP, TenSP, DVT
FROM SANPHAM
WHERE DVT='cay' OR DVT='quyen';

--3)
SELECT MaSP, TenSP
FROM SANPHAM
WHERE MaSP LIKE 'B%01';

--4)
SELECT MaSP, TenSP, NuocSX, Gia
FROM SANPHAM
WHERE NuocSX = 'Trung Quoc' AND Gia BETWEEN 30000 AND 40000;

--5)
SELECT MaSP, TenSP, NuocSX, Gia
FROM SANPHAM
WHERE (NuocSX = 'Trung Quoc' OR NuocSX = 'Thai Lan') AND Gia BETWEEN 30000 AND 40000;

--6)
SELECT SoHD, TriGia, NgHD
FROM HOADON
WHERE NgHD = '1/1/2007' OR NgHD = '1/2/2007';

--7)
SELECT SoHD, TriGia, NgHD
FROM HOADON
WHERE MONTH(NgHD) = 1
ORDER BY NgHD ASC, TriGia DESC;

--8)
SELECT K.MaKH, HoTen
FROM KHACHHANG K, HOADON H
WHERE K.MaKH = H.MaKH AND H.NgHD = '1/1/2007';


--9)
SELECT A.MaNV, A.HoTen, B.SoHD, B.TriGia, B.NgHD
FROM NHANVIEN A, HOADON B
WHERE A.HoTen = 'Nguyen Van B' AND A.MaNV = B.MaNV AND B.NgHD = '10/28/2006';


--10)
SELECT  D.MaSP, D.TenSP
FROM HOADON A, KHACHHANG B, CTHD C, SANPHAM D
WHERE B.MaKH = A.MaKH 
	AND C.SoHD = A.SoHD 
	AND D.MaSP = C.MaSP 
	AND B.HoTen = 'Nguyen Van A' 
	AND MONTH(A.NgHD) = 10 
	AND YEAR(A.NgHD) = 2006;

--11)
SELECT A.SoHD
FROM CTHD A, SANPHAM B
WHERE A.MaSP = B.MaSP AND (A.MaSP = 'BB01' OR A.MaSP = 'BB02');

--12)
SELECT SoHD, MaSP, SL
FROM CTHD
WHERE (MaSP = 'BB01' OR MaSP = 'BB02') AND SL BETWEEN 10 AND 20;

--13)
SELECT * FROM CTHD
SELECT SoHD, MaSP, SL
FROM CTHD
WHERE (SL BETWEEN 10 AND 200) AND (MaSP = 'BB01' AND SoHD IN(SELECT SoHD FROM CTHD WHERE MaSP = 'BB02'));

SELECT * FROM CTHD
SELECT SoHD, MaSP, SL
FROM CTHD
WHERE (SL BETWEEN 10 AND 200) AND (SoHD IN(SELECT SoHD FROM CTHD WHERE MaSP = 'BB01') AND
									SoHD IN(SELECT SoHD FROM CTHD WHERE MaSP = 'BB02')
									);
--14)

select a.makh, HoTen, MaSP
from KHACHHANG a, HOADON b, CTHD c
where a.MaKH = b.MaKH and b.SoHD = c.SoHD

select k.MaKH, d.MaSP
from KHACHHANG k, HOADON h, CTHD d
where k.MaKH = h.MaKH and h.SoHD = d.SoHD and k.MaKH not  in
(select a.makh from KHACHHANG a, HOADON b, CTHD c, SANPHAM s 
where a.MaKH = b.MaKH and b.SoHD = c.SoHD and c.MaSP = s.MaSP and s.NuocSX <> 'viet nam')





select a.MaKH, s.MaSP, nuocsx
from  KHACHHANG a, HOADON b, CTHD c, SANPHAM s 
where a.MaKH = b.MaKH and b.SoHD = c.SoHD and c.MaSP = s.MaSP and a.MaKH in ('kh04', 'kh05')